<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gulsabi's Sky Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            font-family: 'Press Start 2P', cursive;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud {
            padding: 20px;
            color: white;
            text-shadow: 2px 2px 0 #000;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            width: 90%;
            margin: 0 auto;
        }

        .hud-left {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hearts {
            font-size: 20px;
            color: #ff0000;
            text-shadow: 0 0 5px white;
        }

        .combo-text {
            color: #FFFF00;
            font-size: 12px;
            text-shadow: 2px 2px #FF0000;
            display: none;
        }

        .level-indicator {
            color: #FFD700;
            text-align: center;
            line-height: 1.2;
        }
        .hud-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 120px;
            pointer-events: auto;
        }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 12px;
            border: 4px solid #fff;
            color: white;
            pointer-events: auto; 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            min-width: 320px;
            max-width: 95%;
            max-height: 95vh;
            overflow-y: auto; 
        }

        #game-over-screen {
            display: none;
        }

        .start-hero-img {
            width: 80px;
            height: auto;
            animation: floatHero 2s ease-in-out infinite;
            margin-bottom: 10px;
            display: block;
        }

        @keyframes floatHero {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .instructions-box {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .instruction-row {
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
        }

        .instruction-icon { font-size: 20px; width: 30px; text-align: center; }
        
        .item-name { font-size: 10px; color: #fff; display: block; margin-bottom: 2px;}
        .item-desc { font-size: 8px; color: #ccc; display: block;}

        .top-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            width: 108px;
            pointer-events: auto;
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.4); 
            border-radius: 50%;
            width: 32px;
            height: 32px;
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:active { transform: scale(0.9); }

        button.game-btn {
            background: #ffcc00;
            border: 4px solid #e65100;
            color: #d84315;
            padding: 15px 30px;
            font-family: 'Press Start 2P', cursive;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.1s;
            text-transform: uppercase;
            margin-top: 5px;
        }
        button.game-btn:active { transform: scale(0.95); }

        h1 {
            color: #4fc3f7;
            text-shadow: 4px 4px 0 #01579b;
            margin: 0 0 5px 0;
            font-size: 20px;
            line-height: 1.4;
        }

        #powerup-msg {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #FFF;
            font-size: 24px;
            text-shadow: 0 0 10px #FF00FF, 2px 2px 0 #000;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            text-align: center;
            width: 100%;
            font-weight: bold;
        }
        
        .separator {
            border-top: 1px dashed rgba(255,255,255,0.3);
            margin: 5px 0;
            width: 100%;
        }
        
        .final-score-display {
            font-size: 28px; 
            color: #FFD700; 
            text-shadow: 2px 2px 0 #000; 
            font-weight: bold;
            text-align: center;
        }
        
        .score-label {
            font-size: 10px; 
            color: #aaa; 
            text-align: center;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .high-score {
            font-size: 10px;
            color: #FFD700;
            text-shadow: 1px 1px 0 #000;
            text-align: center;
        }
        .help-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.72);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            padding: 12px;
        }
        .help-modal {
            width: min(92vw, 520px);
            max-height: 88vh;
            overflow-y: auto;
            background: rgba(6, 12, 24, 0.96);
            border: 3px solid #fff;
            border-radius: 12px;
            padding: 14px;
            color: #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .help-head { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .help-title { color:#4fc3f7; text-shadow:2px 2px 0 #01579b; font-size:12px; }
        .help-close {
            background:#ff5252; border:2px solid #fff; color:#fff; border-radius:6px;
            width:28px; height:28px; font-family:'Press Start 2P', cursive; font-size:10px; cursor:pointer;
        }
        .help-block { margin-top:10px; border-top:1px dashed rgba(255,255,255,0.35); padding-top:10px; font-size:9px; line-height:1.6; }
        .help-block strong { color:#FFD700; display:block; margin-bottom:4px; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="hud">
            <div class="hud-left">
                <div id="scoreDisplay">SCORE: 0</div>
                <div id="heartsDisplay" class="hearts">LIVES: 3</div>
                <div id="comboDisplay" class="combo-text">COMBO x1</div>
            </div>
            <div class="hud-right">
                <div id="levelDisplay" class="level-indicator">LEVEL: 1</div>
                <div class="top-controls">
                    <button id="help-btn" class="icon-btn" title="Help">?</button>
                    <button id="fullscreen-btn" class="icon-btn" title="Fullscreen">&#9974;</button>
                    <button id="sound-toggle" class="icon-btn" title="Mute">&#9835;</button>
                </div>
            </div>
        </div>
        
        <div id="powerup-msg">SUPERPOWER!</div>

        <div id="start-screen">
            <img src="gulsabi-game-fly.png" class="start-hero-img" alt="Gulsabi" onerror="if(this.src.includes('fly')){this.src='gulsabi-game1.png';}else{this.style.display='none';}">
            <h1>GULSABI'S<br>SKY ADVENTURE</h1>
            <div id="startHighScore" class="high-score">HIGH SCORE: 0</div>
            
            <div class="instructions-box">
                <div class="instruction-row">
                    <span class="instruction-icon">&#129412;</span>
                    <div>
                        <span class="item-name" style="color:#FFD700;">UNICORN</span>
                        <span class="item-desc">Invincibility Shield (6s)</span>
                    </div>
                </div>
                <div class="instruction-row">
                    <span class="instruction-icon">&#128640;</span>
                    <div>
                        <span class="item-name" style="color:#F44336;">JETPACK</span>
                        <span class="item-desc">Auto-Fly & Shoot Lasers</span>
                    </div>
                </div>
                <div class="instruction-row">
                    <span class="instruction-icon">&#128993;</span>
                    <div>
                        <span class="item-name" style="color:#FFF176;">COIN</span>
                        <span class="item-desc">+5 Score Bonus</span>
                    </div>
                </div>
                
                <div class="separator"></div>

                <div class="instruction-row">
                    <span class="instruction-icon">&#9888;</span>
                    <div>
                        <span class="item-name" style="color:#FF5252;">AVOID!</span>
                        <span class="item-desc">Aliens & Asteroids</span>
                    </div>
                </div>
            </div>

            <button id="startBtn" class="game-btn">START GAME</button>
        </div>

        <div id="game-over-screen">
            <img src="gulsabi-game-fly.png" class="start-hero-img" alt="Gulsabi" onerror="if(this.src.includes('fly')){this.src='gulsabi-game1.png';}else{this.style.display='none';}">
            <h1>GAME OVER</h1>
            
            <div class="instructions-box">
                <div style="display: flex; flex-direction: column; align-items: center; padding-bottom: 10px; border-bottom: 1px dashed rgba(255,255,255,0.3); margin-bottom: 10px; width: 100%;">
                    <div class="score-label">TOTAL SCORE</div>
                    <div id="finalScore" class="final-score-display">0</div>
                    <div id="gameOverHighScore" class="high-score">HIGH SCORE: 0</div>
                </div>

                <div class="instruction-row">
                    <span class="instruction-icon">&#129412;</span>
                    <div>
                        <span class="item-name" style="color:#FFD700;">UNICORN</span>
                        <span class="item-desc">Invincibility Shield</span>
                    </div>
                </div>
                <div class="instruction-row">
                    <span class="instruction-icon">&#128640;</span>
                    <div>
                        <span class="item-name" style="color:#F44336;">JETPACK</span>
                        <span class="item-desc">Auto-Fly & Shoot Lasers</span>
                    </div>
                </div>
                <div class="instruction-row">
                    <span class="instruction-icon">&#128993;</span>
                    <div>
                        <span class="item-name" style="color:#FFF176;">COIN</span>
                        <span class="item-desc">+5 Score Bonus</span>
                    </div>
                </div>
                
                <div class="separator"></div>

                <div class="instruction-row">
                    <span class="instruction-icon">&#9888;</span>
                    <div>
                        <span class="item-name" style="color:#FF5252;">AVOID!</span>
                        <span class="item-desc">Aliens & Asteroids</span>
                    </div>
                </div>
            </div>

            <button id="restartBtn" class="game-btn">TRY AGAIN</button>
        </div>
    </div>
        <div id="helpOverlay" class="help-overlay">
            <div class="help-modal">
                <div class="help-head">
                    <div class="help-title">GAME HELP</div>
                    <button id="helpCloseBtn" class="help-close" title="Close">X</button>
                </div>
                <div class="help-block">
                    <strong>How To Play</strong>
                    Hold/tap/space to fly. Avoid aliens and asteroids. Collect power-ups.
                    During jetpack, character auto-aligns and shoots on tap/click/space.
                </div>
                <div class="help-block">
                    <strong>Score Rules</strong>
                    +5 for collecting a coin<br>
                    +20 for collecting unicorn<br>
                    +20 for collecting jetpack<br>
                    +10 for destroying an alien/asteroid with projectile<br>
                    +10 for a close call near-miss<br>
                    +1 when an alien/asteroid exits screen
                </div>
            </div>
        </div>

    <script>
        // --- GAME VARIABLES ---
        let entities = [];
        let projectiles = [];
        let particles = [];
        let floatingTexts = [];
        let bgStars = [];
        let bgClouds = [];
        let inputActive = false;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const heartsDisplay = document.getElementById('heartsDisplay');
        const levelDisplay = document.getElementById('levelDisplay');
        const comboDisplay = document.getElementById('comboDisplay');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreDisplay = document.getElementById('finalScore');
        const startHighScoreDisplay = document.getElementById('startHighScore');
        const gameOverHighScoreDisplay = document.getElementById('gameOverHighScore');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const powerupMsg = document.getElementById('powerup-msg');
        const soundToggle = document.getElementById('sound-toggle');
        const helpBtn = document.getElementById('help-btn');
        const helpOverlay = document.getElementById('helpOverlay');
        const helpCloseBtn = document.getElementById('helpCloseBtn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');

        const STATE = { MENU: 0, PLAYING: 1, GAMEOVER: 2 };
        const HIGH_SCORE_KEY = 'gulsabi_game1_high_score';
        let currentState = STATE.MENU;
        let frames = 0;
        let score = 0;
        let level = 1;
        let gameSpeed = 2;
        let lives = 3;
        let shake = 0;
        let combo = 1;
        let comboTimer = 0;
        let topCampFrames = 0;
        let topObstacleCooldown = 0;
        let nextLevelScore = 260;
        const MAX_LEVEL = 10;

        const SKY_COLORS = [
            ['#81D4FA', '#E1F5FE'],
            ['#A5D6A7', '#E8F5E9'],
            ['#FFCCBC', '#FBE9E7'],
            ['#B39DDB', '#F3E5F5'],
            ['#5C6BC0', '#283593']
        ];

        const gulsabiImg = new Image();
        let gulsabiImgLoaded = false;
        gulsabiImg.src = 'gulsabi-game-fly.png'; 
        gulsabiImg.onload = () => { gulsabiImgLoaded = true; };
        gulsabiImg.onerror = () => { 
            if (gulsabiImg.src.includes('fly')) {
                 gulsabiImg.src = 'gulsabi-game1.png'; 
            }
        };
        function getHighScore() {
            const raw = localStorage.getItem(HIGH_SCORE_KEY);
            const n = parseInt(raw || '0', 10);
            return Number.isFinite(n) && n > 0 ? n : 0;
        }
        function setHighScore(v) { localStorage.setItem(HIGH_SCORE_KEY, String(v)); }
        function refreshHighScoreUI() {
            const hs = getHighScore();
            if (startHighScoreDisplay) startHighScoreDisplay.innerText = 'HIGH SCORE: ' + hs;
            if (gameOverHighScoreDisplay) gameOverHighScoreDisplay.innerText = 'HIGH SCORE: ' + hs;
        }

        // --- AUDIO OBJECT ---
        const audio = {
            ctx: null, isMuted: false, isPlayingMusic: false, timerID: null,
            melody: [261, 329, 392, 493, 523, 493, 392, 329, 220, 261, 329, 440, 493, 440, 329, 261],
            noteIndex: 0, nextNoteTime: 0, tempo: 0.12,

            voices: {
                chant: new Audio('audio/gulsabi_chant.mp3'),
                invincible: new Audio('audio/invincible.mp3'),
                jetpack: new Audio('audio/jetpack.mp3'),
                levelUp: new Audio('audio/level_up.mp3')
            },

            init: function() { 
                if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
                if (this.ctx.state === 'suspended') this.ctx.resume(); 
            },

            toggleMute: function() {
                this.isMuted = !this.isMuted; 
                soundToggle.innerText = this.isMuted ? '\u2715' : '\u266B';
                if(this.isMuted) { 
                    this.stopMusic(); 
                    Object.values(this.voices).forEach(v => { v.pause(); v.currentTime = 0; });
                }
                else if (currentState === STATE.PLAYING) this.startMusic();
            },

            playSound: function(type) {
                if(this.isMuted || !this.ctx) return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain(); const now = this.ctx.currentTime;
                osc.connect(gain); gain.connect(this.ctx.destination);
                switch(type) {
                    case 'jump': osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(300, now+0.1); gain.gain.value=0.1; osc.start(); osc.stop(now+0.1); break;
                    case 'coin': osc.type='sine'; osc.frequency.setValueAtTime(1200, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1); osc.start(); osc.stop(now+0.1); break;
                    case 'laser': osc.type='square'; osc.frequency.setValueAtTime(800, now); osc.frequency.exponentialRampToValueAtTime(100, now+0.15); gain.gain.value=0.05; osc.start(); osc.stop(now+0.15); break;
                    case 'explode': osc.type='sawtooth'; osc.frequency.value=100; gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.2); osc.start(); osc.stop(now+0.2); if(navigator.vibrate) navigator.vibrate(50); break;
                    case 'hit': osc.type='sawtooth'; osc.frequency.value=150; gain.gain.value=0.1; osc.start(); osc.stop(now+0.3); if(navigator.vibrate) navigator.vibrate(200); break;
                    case 'nearmiss': osc.type='triangle'; osc.frequency.value=600; gain.gain.value=0.1; osc.start(); osc.stop(now+0.15); break;
                }
            },

            playVoice: function(key) {
                if(this.isMuted) return;
                const voiceFile = this.voices[key];
                if (voiceFile) {
                    voiceFile.currentTime = 0;
                    voiceFile.play().catch(e => {
                        console.warn(`Voice file audio/${key}.mp3 not found, using fallback SFX.`);
                        this.playSound('coin'); 
                    });
                }
            },

            startMusic: function() { if(this.isMuted || this.isPlayingMusic) return; this.isPlayingMusic=true; this.nextNoteTime=this.ctx.currentTime+0.1; this.scheduleNote(); },
            stopMusic: function() { this.isPlayingMusic=false; clearTimeout(this.timerID); },
            scheduleNote: function() {
                if(!this.isPlayingMusic) return;
                while(this.nextNoteTime < this.ctx.currentTime+0.1) {
                    const f = this.melody[this.noteIndex];
                    if(f>0 && !this.isMuted) {
                        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                        o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.08, this.nextNoteTime); g.gain.exponentialRampToValueAtTime(0.001, this.nextNoteTime+this.tempo-0.02);
                        o.connect(g); g.connect(this.ctx.destination); o.start(this.nextNoteTime); o.stop(this.nextNoteTime+this.tempo);
                    }
                    this.nextNoteTime+=this.tempo; this.noteIndex=(this.noteIndex+1)%this.melody.length;
                }
                this.timerID = setTimeout(()=>this.scheduleNote(), 25);
            }
        };

        class FloatingText {
            constructor(x,y,t,c){this.x=x;this.y=y;this.text=t;this.color=c||'#FFF';this.life=1.0;this.vy=-2;}
            update(){this.y+=this.vy;this.life-=0.02;}
            draw(ctx){ctx.globalAlpha=Math.max(0,this.life);ctx.fillStyle=this.color;ctx.font='bold 16px Arial';ctx.strokeStyle='black';ctx.lineWidth=2;ctx.strokeText(this.text,this.x,this.y);ctx.fillText(this.text,this.x,this.y);ctx.globalAlpha=1.0;}
        }

        class Particle {
            constructor(x,y,t){this.x=x;this.y=y;this.type=t;this.vx=(Math.random()-0.5)*5;this.vy=(Math.random()-0.5)*5;this.life=1.0;this.color=t==='fire'?`hsl(${Math.random()*50},100%,50%)`:t==='red_trail'?'rgba(255,0,0,0.8)':'#FFF';}
            update(){this.x+=this.vx;this.y+=this.vy;this.life-=0.03;}
            draw(ctx){ctx.globalAlpha=this.life;ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.x,this.y,3*this.life,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1.0;}
        }

        class Projectile {
            constructor(x,y){this.x=x;this.y=y;this.w=20;this.h=5;this.speed=10;this.del=false;}
            update(){this.x+=this.speed;if(this.x>canvas.width)this.del=true;if(Math.random()>0.5)particles.push(new Particle(this.x,this.y,'fire'));}
            draw(ctx){ctx.fillStyle='#00FF00';ctx.fillRect(this.x,this.y,this.w,this.h);}
        }

        class Entity {
            constructor(t){this.type=t;this.w=50;this.h=50;this.x=canvas.width;this.y=Math.random()*(canvas.height-100);this.speed=gameSpeed;this.del=false;this.angle=0;this.nm=false;
            if(t==='coin'){this.w=30;this.h=30;}
            if(t==='unicorn'){this.w=68;this.h=52;}
            if(t==='jetpack'){this.w=60;this.h=40;}}
            update(){this.x-=this.speed;if(this.x+this.w<-50)this.del=true;if(this.type!=='asteroid'){this.angle+=0.1;this.y+=Math.sin(this.angle)*1.5;}else{this.angle+=0.05;}if((this.type==='alien'||this.type==='asteroid') && frames%5===0) particles.push(new Particle(this.x+this.w,this.y+this.h/2,'red_trail'));}
            draw(ctx){
                ctx.save(); ctx.translate(this.x+this.w/2, this.y+this.h/2);
                if(this.type==='coin'){ctx.scale(Math.abs(Math.sin(frames*0.1)),1);ctx.fillStyle='#FFD700';ctx.beginPath();ctx.arc(0,0,15,0,Math.PI*2);ctx.fill();ctx.strokeStyle='#DAA520';ctx.lineWidth=3;ctx.stroke();ctx.fillStyle='#FFF';ctx.font='bold 20px Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('$',0,2);}
                else if(this.type==='asteroid'){ctx.rotate(this.angle);ctx.fillStyle='#795548';ctx.beginPath();ctx.moveTo(0,-22);ctx.lineTo(18,-15);ctx.lineTo(25,0);ctx.lineTo(15,20);ctx.lineTo(-5,25);ctx.lineTo(-22,10);ctx.lineTo(-20,-15);ctx.fill();ctx.fillStyle='#4E342E';ctx.beginPath();ctx.arc(-5,-5,6,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(10,10,4,0,Math.PI*2);ctx.fill();}
                else if(this.type==='alien'){ctx.fillStyle='#81D4FA';ctx.globalAlpha=0.6;ctx.beginPath();ctx.arc(0,-10,15,Math.PI,0);ctx.fill();ctx.globalAlpha=1.0;ctx.fillStyle='#76FF03';ctx.beginPath();ctx.arc(0,-10,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='black';ctx.fillRect(-3,-12,2,2);ctx.fillRect(3,-12,2,2);ctx.fillStyle='#424242';ctx.beginPath();ctx.ellipse(0,0,25,10,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#555'; ctx.fillRect(-28, -2, 6, 8); ctx.fillRect(22, -2, 6, 8);ctx.fillStyle='#222'; ctx.fillRect(-32, 0, 10, 3); ctx.fillRect(22, 0, 10, 3);ctx.fillStyle='#F44336'; ctx.beginPath(); ctx.arc(-32, 1.5, 1.5, 0, Math.PI*2); ctx.fill();ctx.beginPath(); ctx.arc(32, 1.5, 1.5, 0, Math.PI*2); ctx.fill();ctx.fillStyle='#757575'; ctx.fillRect(-30,-2,10,4);ctx.fillRect(20,-2,10,4);ctx.fillStyle='#F44336';for(let i=-1;i<=1;i++){ctx.beginPath();ctx.arc(i*15,0,3,0,Math.PI*2);ctx.fill();}}
                else if(this.type==='unicorn'){
                    const bob = Math.sin(frames * 0.12) * 2;
                    ctx.translate(0, bob);
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.9)';
                    ctx.shadowBlur = 10;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = '46px "Segoe UI Emoji","Apple Color Emoji","Noto Color Emoji",sans-serif';
                    ctx.fillText('🦄', 0, 4);
                    ctx.shadowBlur = 0;
                }
                else if(this.type==='jetpack'){ctx.fillStyle = '#CFD8DC'; ctx.fillRect(-15, -15, 10, 30); ctx.fillRect(5, -15, 10, 30);ctx.fillStyle = '#546E7A'; ctx.fillRect(-8, -10, 16, 20);ctx.fillStyle = '#FFEB3B'; ctx.beginPath(); ctx.moveTo(0, -5); ctx.lineTo(6, -5); ctx.lineTo(2, 2); ctx.lineTo(6, 2); ctx.lineTo(-2, 12); ctx.lineTo(0, 4); ctx.lineTo(-4, 4); ctx.closePath(); ctx.fill();ctx.fillStyle = '#FF5722'; ctx.fillRect(-18, -5, 36, 8);ctx.fillStyle = '#37474F'; ctx.beginPath(); ctx.moveTo(-15, 15); ctx.lineTo(-10, 22); ctx.lineTo(-5, 15); ctx.fill();ctx.beginPath(); ctx.moveTo(5, 15); ctx.lineTo(10, 22); ctx.lineTo(15, 15); ctx.fill();const fL = Math.random() * 12 + 8;ctx.fillStyle = '#FF5722'; ctx.beginPath(); ctx.moveTo(-13, 22); ctx.lineTo(-10, 22 + fL); ctx.lineTo(-7, 22); ctx.fill();ctx.beginPath(); ctx.moveTo(7, 22); ctx.lineTo(10, 22 + fL); ctx.lineTo(13, 22); ctx.fill();}
                ctx.restore();
            }
        }

        const gulsabi = {
            x:50,y:200,w:58,h:58,vy:0,gravity:0.15,lift:-4,invincible:0,autopilot:0,hurt:0,spin:0,lastShot:0,shotCooldown:180,
            update:function(){
                const isAP=Date.now()<this.autopilot;
                if(isAP){
                    const target = entities
                        .filter(e => !e.del && (e.type === 'alien' || e.type === 'asteroid') && (e.x + e.w) >= this.x)
                        .sort((a, b) => a.x - b.x)[0];
                    const targetY = target ? (target.y + (target.h / 2) - (this.h / 2)) : (canvas.height / 2);
                    this.y += (targetY - this.y) * 0.12;
                    this.vy = 0;
                }
                else{if(inputActive){this.vy+=this.lift*0.15;if(this.vy<-5)this.vy=-5;}this.vy+=this.gravity;if(this.vy>4)this.vy=4;this.y+=this.vy;}
                if(this.spin>0)this.spin-=0.2;
                if(this.y<0)this.y=0;
                if(this.y+this.h>canvas.height){this.y=canvas.height-this.h;if(Date.now()>this.invincible)takeDamage();}
                if(frames%5===0)particles.push(new Particle(this.x,this.y+25,isAP?'fire':'smoke'));
            },
            draw:function(){
                if(Date.now()<this.hurt && Math.floor(Date.now()/100)%2===0)return;
                ctx.save();ctx.translate(this.x+this.w/2,this.y+this.h/2);
                let r=Math.min(Math.PI/4,Math.max(-Math.PI/4,this.vy*0.1));if(Date.now()<this.autopilot)r=0;ctx.rotate(r+this.spin);
                if(Date.now()<this.invincible||Date.now()<this.autopilot){ctx.strokeStyle=`hsl(${frames*5},100%,50%)`;ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,40,0,Math.PI*2);ctx.stroke();}
                if(gulsabiImgLoaded)ctx.drawImage(gulsabiImg,-this.w/2,-this.h/2,this.w,this.h);
                ctx.restore();
            }
        };

        function fireJetpackShot(){
            const now = Date.now();
            if (currentState !== STATE.PLAYING || now >= gulsabi.autopilot) return false;
            if (now - gulsabi.lastShot < gulsabi.shotCooldown) return true;
            projectiles.push(new Projectile(gulsabi.x + gulsabi.w - 5, gulsabi.y + (gulsabi.h / 2)));
            gulsabi.lastShot = now;
            audio.playSound('laser');
            return true;
        }
        function handleStart(e){
            if(e.target.tagName==='BUTTON' || e.target.tagName==='INPUT') return;
            if(currentState!==STATE.PLAYING) return;
            if (fireJetpackShot()) return;
            inputActive=true;audio.playSound('jump');
        }
        function handleEnd(){inputActive=false;}
        window.addEventListener('mousedown',handleStart); window.addEventListener('mouseup',handleEnd);
        window.addEventListener('touchstart',handleStart,{passive:false}); window.addEventListener('touchend',handleEnd);
        window.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();handleStart(e);}});
        window.addEventListener('keyup',e=>{if(e.code==='Space')handleEnd();});

        function init() {
            bgStars = []; for(let i=0; i<50; i++) bgStars.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2});
            bgClouds = []; for(let i=0; i<5; i++) bgClouds.push({x: Math.random()*canvas.width, y: Math.random()*200, s: 0.5 + Math.random()});
            resize();
        }

        function getDifficulty() {
            const lvl = Math.max(1, Math.min(level, MAX_LEVEL));
            return {
                obstacleSpeed: Math.min(2.8 + (lvl - 1) * 0.35, 6.0),
                spawnInterval: Math.max(100 - (lvl - 1) * 5, 52),
                obstacleBurstChance: Math.min(0.05 + (lvl - 1) * 0.02, 0.24),
                powerupChance: Math.max(0.28 - (lvl - 1) * 0.015, 0.16),
                maxObstaclesOnScreen: Math.min(3 + Math.floor((lvl - 1) / 2), 7),
                topPunishCooldown: Math.max(42 - (lvl - 1) * 2, 20)
            };
        }

        function levelUp() {
            if (level >= MAX_LEVEL) return;
            level++;
            gameSpeed = getDifficulty().obstacleSpeed;
            nextLevelScore += 260 + (level * 110);
            gulsabi.spin = Math.PI * 2;
            audio.playVoice("levelUp");
            updateHUD();
        }

        function spawn() {
            const d = getDifficulty();
            if (frames % d.spawnInterval === 0) {
                let r = Math.random();
                let type = 'asteroid';
                const powerupChance = d.powerupChance;
                if (r < powerupChance * 0.25) type = 'jetpack';
                else if (r < powerupChance * 0.55) type = 'unicorn';
                else if (r < powerupChance) type = 'coin';
                else if (r < (powerupChance + 0.38)) type = 'alien';
                entities.push(new Entity(type));

                const obstacleCount = entities.filter(e => !e.del && (e.type === 'alien' || e.type === 'asteroid')).length;
                if ((type === 'alien' || type === 'asteroid') && obstacleCount < d.maxObstaclesOnScreen && Math.random() < d.obstacleBurstChance) {
                    const extra = new Entity(Math.random() < 0.55 ? 'asteroid' : 'alien');
                    extra.y = Math.max(10, Math.min(canvas.height - extra.h - 10, Math.random() * (canvas.height - extra.h)));
                    entities.push(extra);
                }
            }
            if (topCampFrames > 90 && topObstacleCooldown <= 0) {
                const forced = new Entity(Math.random() < 0.5 ? 'asteroid' : 'alien');
                forced.y = Math.random() * Math.min(80, canvas.height * 0.18);
                entities.push(forced);
                topObstacleCooldown = d.topPunishCooldown;
            }
        }

        function addScore(points, x, y) {
            const finalPoints = points * combo; score += finalPoints;
            floatingTexts.push(new FloatingText(x, y, `+${finalPoints}`, '#FFFF00'));
            combo++; comboTimer = 120; updateHUD();
        }

        function explode(x, y) { audio.playSound('explode'); shake = 10; for(let i=0; i<15; i++) particles.push(new Particle(x, y, 'fire')); }
        function showMsg(text) { powerupMsg.innerText = text; powerupMsg.style.opacity = 1; }

        function takeDamage() {
            if(Date.now() < gulsabi.invincible || Date.now() < gulsabi.hurt) return;
            lives--; updateHUD(); audio.playSound('hit');
            if(lives <= 0) gameOver();
            else { gulsabi.hurt = Date.now() + 2000; shake = 20; combo = 1; }
        }

        function updateHUD() {
            scoreDisplay.innerText = `SCORE: ${score}`; heartsDisplay.innerText = `LIVES: ${lives}`; levelDisplay.innerText = `LEVEL: ${level}`;
            if(combo > 1) { comboDisplay.innerText = `COMBO x${combo}`; comboDisplay.style.display = 'block'; comboDisplay.style.transform = `scale(${1 + combo*0.1})`; }
            else comboDisplay.style.display = 'none';
        }

        function update() {
            if(currentState !== STATE.PLAYING)return;
            frames++; if(shake>0)shake*=0.9; if (topObstacleCooldown > 0) topObstacleCooldown--;
            if(comboTimer>0){comboTimer--;if(comboTimer===0){combo=1;updateHUD();}}
            gulsabi.update(); spawn(); if (gulsabi.y <= canvas.height * 0.12) topCampFrames++; else topCampFrames = 0;
            bgStars.forEach(s=>{s.x-=gameSpeed*0.2;if(s.x<0)s.x=canvas.width;});
            bgClouds.forEach(c=>{c.x-=gameSpeed*0.5;if(c.x<-100)c.x=canvas.width;});
            for(let i=projectiles.length-1;i>=0;i--){
                let p=projectiles[i];p.update();
                for(let j=entities.length-1;j>=0;j--){
                    let e=entities[j];
                    if((e.type==='alien'||e.type==='asteroid') && checkRectCollide(p,e)){explode(e.x+e.w/2,e.y+e.h/2);addScore(10,e.x,e.y);entities.splice(j,1);p.del=true;}
                }
                if(p.del)projectiles.splice(i,1);
            }
            for(let i=entities.length-1;i>=0;i--){
                let e=entities[i];e.speed=gameSpeed;e.update();
                if(!e.nm && (e.type==='alien'||e.type==='asteroid')){
                    let d=Math.sqrt(Math.pow((gulsabi.x+gulsabi.w/2)-(e.x+e.w/2),2)+Math.pow((gulsabi.y+gulsabi.h/2)-(e.y+e.h/2),2));
                    if(d<100&&gulsabi.x>e.x+e.w){e.nm=true;addScore(10,gulsabi.x,gulsabi.y-20);audio.playSound('nearmiss');floatingTexts.push(new FloatingText(gulsabi.x,gulsabi.y-40,"CLOSE CALL!","#FFA500"));}
                }
                if(checkRectCollide(gulsabi,e)){
                    if(e.type==='coin'){addScore(5,e.x,e.y);audio.playSound('coin');entities.splice(i,1);}
                    else if(e.type==='unicorn'){addScore(20,e.x,e.y);gulsabi.invincible=Date.now()+6000;audio.playVoice("invincible");showMsg("INVINCIBLE!");entities.splice(i,1);}
                    else if(e.type==='jetpack'){addScore(20,e.x,e.y);gulsabi.autopilot=Date.now()+5000;audio.playVoice("jetpack");showMsg("AUTOPILOT!");entities.splice(i,1);}
                    else{
                        if(Date.now()<gulsabi.invincible||Date.now()<gulsabi.autopilot){explode(e.x+e.w/2,e.y+e.h/2);addScore(10,e.x,e.y);entities.splice(i,1);}
                        else{takeDamage();explode(e.x+e.w/2,e.y+e.h/2);entities.splice(i,1);}
                    }
                    updateHUD();
                }
                if(e.del){entities.splice(i,1);if(e.type!=='coin'&&e.type!=='unicorn'&&e.type!=='jetpack'){score++;updateHUD();}}
            }
            for(let i=particles.length-1;i>=0;i--){particles[i].update();if(particles[i].life<=0)particles.splice(i,1);}
            for(let i=floatingTexts.length-1;i>=0;i--){floatingTexts[i].update();if(floatingTexts[i].life<=0)floatingTexts.splice(i,1);}
            while (score >= nextLevelScore && level < MAX_LEVEL) levelUp();
            if(Date.now()>gulsabi.invincible&&Date.now()>gulsabi.autopilot)powerupMsg.style.opacity=0;
        }

        function checkRectCollide(a, b) { const pad = 10; return (a.x+pad < b.x+b.w-pad && a.x+a.w-pad > b.x+pad && a.y+pad < b.y+b.h-pad && a.y+a.h-pad > b.y+pad); }

        function draw() {
            ctx.save(); if(shake > 0) ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
            let cIdx = Math.min(level - 1, 4); const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
            grad.addColorStop(0, SKY_COLORS[cIdx][0]); grad.addColorStop(1, SKY_COLORS[cIdx][1]);
            ctx.fillStyle = grad; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white'; bgStars.forEach(s => { ctx.globalAlpha = Math.random()*0.5 + 0.5; ctx.beginPath(); ctx.arc(s.x, s.y, s.s, 0, Math.PI*2); ctx.fill(); });
            ctx.globalAlpha = 1.0;
            ctx.fillStyle = 'rgba(255,255,255,0.5)'; bgClouds.forEach(c => { ctx.beginPath(); ctx.arc(c.x, c.y, 40*c.s, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(c.x+30, c.y-10, 50*c.s, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(c.x+60, c.y, 40*c.s, 0, Math.PI*2); ctx.fill(); });
            entities.forEach(e => e.draw(ctx)); projectiles.forEach(p => p.draw(ctx)); particles.forEach(p => p.draw(ctx)); gulsabi.draw(); floatingTexts.forEach(ft => ft.draw(ctx));
            if (Date.now() < gulsabi.autopilot) {
                const max = 5000; const rem = gulsabi.autopilot - Date.now(); const pct = Math.max(0, rem / max);
                ctx.save(); const bW = 200, bH = 15, bX = (canvas.width - bW) / 2, bY = 60;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'; ctx.fillRect(bX, bY, bW, bH);
                ctx.fillStyle = '#FF5722'; ctx.fillRect(bX + 2, bY + 2, (bW - 4) * pct, bH - 4);
                ctx.fillStyle = '#FFF'; ctx.font = '10px "Press Start 2P"'; ctx.textAlign = 'center'; ctx.fillText("JETPACK FUEL", canvas.width / 2, bY - 5);
                ctx.restore();
            }
            ctx.restore();
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

        function startGame() {
            audio.init(); audio.startMusic();
            audio.playVoice('chant');
            score = 0; level = 1; nextLevelScore = 260; gameSpeed = getDifficulty().obstacleSpeed; lives = 3; combo = 1;
            gulsabi.x = 50; gulsabi.y = canvas.height/2; gulsabi.vy = 0; gulsabi.invincible = 0; gulsabi.autopilot = 0; gulsabi.lastShot = 0; topCampFrames = 0; topObstacleCooldown = 0;
            entities = []; projectiles = []; particles = []; floatingTexts = [];
            updateHUD(); startScreen.style.display = 'none'; gameOverScreen.style.display = 'none'; currentState = STATE.PLAYING;
        }

        function gameOver() { audio.stopMusic(); currentState = STATE.GAMEOVER; if (score > getHighScore()) setHighScore(score); finalScoreDisplay.innerText = `${score}`; refreshHighScoreUI(); gameOverScreen.style.display = 'flex'; }
        function openHelp(){ helpOverlay.style.display = 'flex'; }
        function closeHelp(){ helpOverlay.style.display = 'none'; }

        startBtn.onclick = startGame;
        restartBtn.onclick = startGame;
        soundToggle.onclick = () => audio.toggleMute();
        helpBtn.onclick = () => openHelp();
        helpCloseBtn.onclick = () => closeHelp();
        helpOverlay.onclick = (e) => { if (e.target === helpOverlay) closeHelp(); };
        fullscreenBtn.onclick = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); };
        
        window.addEventListener('resize', resize);
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && helpOverlay.style.display === 'flex') closeHelp(); });
        refreshHighScoreUI();
        init();
        loop();
    </script>
</body>
</html>
