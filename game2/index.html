<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Color Cannon – Gulsabi Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
<style>
/* ════════════════════════════════
   RESET + RESPONSIVE FOUNDATION
════════════════════════════════ */
*, *::before, *::after {
  margin:0; padding:0; box-sizing:border-box;
  user-select:none; -webkit-tap-highlight-color:transparent;
}
html {
  /* Root em = fluid between 320px and 480px screens */
  font-size: clamp(13px, 3.8vw, 18px);
}
html, body { width:100%; height:100%; overflow:hidden; }
body {
  font-family:'Fredoka One', cursive;
  background:#4FC3F7;
  display:flex; flex-direction:column;
  align-items:stretch;
  position:relative;
}

/* ════ BACKGROUND ════ */
.sky {
  position:fixed; inset:0; z-index:0;
  background:linear-gradient(175deg,#0288D1 0%,#29B6F6 30%,#4FC3F7 55%,#81D4FA 78%,#B3E5FC 100%);
}
.sun {
  position:fixed; top:2.5vh; right:6vw; z-index:1;
  width:clamp(44px,9vw,70px); height:clamp(44px,9vw,70px);
  border-radius:50%;
  background:radial-gradient(circle,#FFF176 50%,#FFD600 75%,#FFA000 100%);
  box-shadow:0 0 0 10px rgba(255,220,50,.2), 0 0 50px 20px rgba(255,200,0,.4);
  animation:sunPulse 3.5s ease-in-out infinite;
}
@keyframes sunPulse {
  0%,100% { box-shadow:0 0 0 10px rgba(255,220,50,.2),0 0 50px 20px rgba(255,200,0,.4); }
  50%     { box-shadow:0 0 0 22px rgba(255,220,50,.08),0 0 75px 28px rgba(255,200,0,.55); }
}
.cloud {
  position:fixed; z-index:1; background:white; border-radius:50px;
  opacity:.82; animation:cDrift linear infinite;
}
.cloud::before,.cloud::after { content:''; position:absolute; background:white; border-radius:50%; }
.cl1 { width:clamp(90px,22vw,145px); height:clamp(26px,6vw,42px); top:6vh; animation-duration:36s; animation-delay:0s; }
.cl1::before { width:55%; height:150%; top:-75%; left:16%; }
.cl1::after  { width:40%; height:120%; top:-60%; left:50%; }
.cl2 { width:clamp(65px,16vw,100px); height:clamp(18px,4.5vw,30px); top:11vh; opacity:.55; animation-duration:50s; animation-delay:-20s; }
.cl2::before { width:52%; height:145%; top:-72%; left:12%; }
.cl2::after  { width:38%; height:115%; top:-55%; left:44%; }
@keyframes cDrift { 0%{transform:translateX(-200px);} 100%{transform:translateX(115vw);} }

.ground {
  position:fixed; bottom:0; left:0; right:0; z-index:2;
  height:32vh;
  background:linear-gradient(180deg,#66BB6A 0%,#388E3C 28%,#2E7D32 100%);
  border-radius:50% 50% 0 0 / 2vh 2vh 0 0;
}
.ground::before {
  content:''; position:absolute; top:0; left:0; right:0; height:1.8vh;
  background:linear-gradient(90deg,#81C784,#A5D6A7,#66BB6A,#81C784,#A5D6A7);
  border-radius:50% 50% 0 0;
}
.sp {
  position:fixed; pointer-events:none; z-index:3;
  animation:spFloat ease-in-out infinite;
  font-size:clamp(.7rem,3vw,1.1rem);
}
@keyframes spFloat {
  0%,100% { transform:translateY(0) rotate(0deg); opacity:.5; }
  50%     { transform:translateY(-14px) rotate(22deg); opacity:1; }
}

/* ════ TIMER ════ */
.twrap {
  width:100%; height:clamp(8px,1.5vh,12px);
  position:fixed; top:0; z-index:900;
  background:rgba(0,0,0,.14);
}
.tbar {
  height:100%; width:100%; background:#69F0AE;
  border-radius:0 6px 6px 0;
  transition:width .1s linear, background .35s;
}

/* ════ HEADER ════ */
.hdr {
  width:100%; padding:clamp(10px,2vh,18px) clamp(10px,3vw,18px) 0;
  display:flex; justify-content:space-between; align-items:center;
  position:fixed; top:clamp(8px,1.5vh,14px); z-index:800; pointer-events:none;
}
.pill {
  background:rgba(255,255,255,.93); padding:.4em .85em;
  border-radius:2em; border:3px solid white; pointer-events:auto;
  font-size:clamp(.75rem,3.5vw,1rem);
  box-shadow:0 4px 14px rgba(0,0,0,.15); backdrop-filter:blur(6px);
}

/* ════ STAGE – Gulsabi + Card ════ */
.stage {
  position:fixed;
  /* sits in the upper-middle zone, above the cannon deck */
  top:clamp(52px,11vh,90px);
  bottom:clamp(110px,22vh,170px);
  left:0; right:0; z-index:60;
  display:flex; align-items:center; justify-content:center;
  gap:clamp(8px,3vw,18px); padding:0 clamp(6px,2vw,14px);
}

/* ════ GULSABI FACE ════ */
.gw { display:flex; flex-direction:column; align-items:center; gap:.4em; flex-shrink:0; }
.gface {
  width:clamp(62px,17vw,96px); height:clamp(62px,17vw,96px);
  border-radius:50%; border:4px solid white; overflow:hidden; background:white;
  box-shadow:0 6px 22px rgba(0,0,0,.22);
  transition:border-color .25s, box-shadow .25s;
}
.gface img { width:100%; height:100%; object-fit:cover; display:block; }
.gname {
  background:rgba(255,255,255,.93); padding:.2em .65em; border-radius:.8em;
  font-size:clamp(.6rem,2.8vw,.85rem); border:2px solid white;
  box-shadow:0 2px 7px rgba(0,0,0,.1);
}
.gface.happy    { border-color:#FFD600; box-shadow:0 0 0 5px rgba(255,214,0,.3),0 6px 22px rgba(255,214,0,.5); }
.gface.sad      { border-color:#FF5252; box-shadow:0 0 0 5px rgba(255,82,82,.3), 0 6px 22px rgba(255,82,82,.45); }
.gface.thinking { border-color:#AA00FF; box-shadow:0 0 0 5px rgba(170,0,255,.25),0 6px 22px rgba(170,0,255,.4); }

/* ════ CARD BOARD ════ */
#tasm { position:relative; flex-shrink:0; }
.board {
  /* Square, fits between header and deck with room to breathe */
  width:  clamp(150px, 42vw, 240px);
  height: clamp(150px, 42vw, 240px);
  background:linear-gradient(145deg,#C27C3A,#7B4A1E);
  border:clamp(4px,1.2vw,7px) solid #3E1F00; border-radius:clamp(12px,3vw,20px);
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 8px 28px rgba(0,0,0,.24), inset 0 2px 5px rgba(255,255,255,.18);
  position:relative;
}
.board::before {
  content:''; position:absolute; inset:5px; border-radius:clamp(8px,2vw,14px);
  border:3px dashed rgba(255,255,255,.28); pointer-events:none;
}
.iframe {
  width:82%; height:82%; background:white; border-radius:clamp(8px,2vw,14px);
  overflow:hidden; display:flex; align-items:center; justify-content:center;
  box-shadow:inset 0 3px 10px rgba(0,0,0,.1);
}
.iframe img { width:100%; height:100%; object-fit:contain; }
.nail {
  position:absolute; width:clamp(9px,2.5vw,14px); height:clamp(9px,2.5vw,14px);
  background:#8D6E63; border-radius:50%; border:3px solid #3E1F00;
  box-shadow:0 2px 4px rgba(0,0,0,.4);
}
.nail.tl{top:6px;left:6px;} .nail.tr{top:6px;right:6px;}
.nail.bl{bottom:6px;left:6px;} .nail.br{bottom:6px;right:6px;}

/* ════ CANNON DECK ════ */
.deck {
  position:fixed; bottom:0; left:0; right:0; z-index:600;
  background:linear-gradient(180deg,transparent 0%,rgba(255,255,255,.97) 18%);
  padding:clamp(2px,1vh,6px) clamp(2px,1vw,6px) clamp(8px,2.5vh,18px);
  display:flex; justify-content:space-around; align-items:flex-end;
  height:clamp(105px,21vh,165px);
}
.cw {
  display:flex; flex-direction:column; align-items:center;
  cursor:pointer; gap:clamp(2px,0.5vh,4px);
  border-radius:clamp(10px,2vw,16px);
  transition:transform .15s;
  /* each catapult takes 1/4 of the deck width */
  width:23%; max-width:80px;
  padding:2px;
}
.cw:active { transform:scale(.86); }
.cw svg { width:100%; height:auto; filter:drop-shadow(0 3px 6px rgba(0,0,0,.22)); overflow:visible; }
.clabel {
  font-size:clamp(.58rem,2.6vw,.82rem); font-weight:bold; color:#222;
  padding:.15em .55em; border-radius:.6em; border:2.5px solid rgba(255,255,255,.9);
  background:rgba(255,255,255,.92); white-space:nowrap; letter-spacing:.01em;
}
.cfire { animation:cRecoil .22s ease; }
@keyframes cRecoil {
  0%   { transform:translateY(0) scale(1); }
  40%  { transform:translateY(clamp(5px,1.5vw,9px)) scale(.93); }
  100% { transform:translateY(0) scale(1); }
}

/* ════ FX ════ */
.proj {
  position:fixed; border-radius:50%; pointer-events:none; z-index:1000;
  animation:projUp .38s cubic-bezier(.2,1,.3,1) forwards;
}
@keyframes projUp { 0%{opacity:1;transform:scale(1);}100%{opacity:0;transform:translateY(-72vh) scale(.2);} }

.sflash { position:fixed; inset:0; z-index:1050; pointer-events:none; }
.fhit  { animation:flashG .4s ease forwards; }
.fmiss { animation:flashR .4s ease forwards; }
@keyframes flashG { 0%{background:rgba(105,240,174,.55);} 100%{background:transparent;} }
@keyframes flashR { 0%{background:rgba(255,82,82,.55);}  100%{background:transparent;} }

.spop {
  position:fixed; font-size:clamp(1.4rem,5vw,2.1rem); font-weight:900;
  color:#FFD600; -webkit-text-stroke:2px #BF360C;
  pointer-events:none; z-index:1060;
  animation:popUp 1s ease forwards;
}
@keyframes popUp { 0%{transform:translateY(0) scale(.5);opacity:1;}100%{transform:translateY(-90px) scale(1.3);opacity:0;} }

.conf { position:fixed; width:9px; height:9px; pointer-events:none; z-index:1040; animation:confDrop linear forwards; }
@keyframes confDrop { 0%{opacity:1;transform:rotate(0);}100%{opacity:0;transform:translateY(100vh) rotate(800deg);} }

/* ════ GULSABI ANIMS ════ */
@keyframes dropIn { 0%{transform:translateY(-100vh);}100%{transform:translateY(0);} }
.adrop   { animation:dropIn .55s cubic-bezier(.175,.885,.32,1.275) forwards; }
.abounce { animation:gBounce .42s ease 2; }
@keyframes gBounce { 0%,100%{transform:scale(1);}40%{transform:scale(1.22);}70%{transform:scale(.88);} }
.ashake  { animation:gShake .5s ease; }
@keyframes gShake {
  0%,100%{transform:translateX(0);}
  20%{transform:translateX(-9px);}40%{transform:translateX(9px);}
  60%{transform:translateX(-5px);}80%{transform:translateX(5px);}
}
.awiggle { animation:gWiggle .65s ease infinite; }
@keyframes gWiggle { 0%,100%{transform:rotate(0);}30%{transform:rotate(-12deg);}70%{transform:rotate(12deg);} }

/* ════ OVERLAYS ════ */
.ov {
  position:fixed; inset:0; z-index:7000;
  display:flex; align-items:center; justify-content:center;
  visibility:hidden; opacity:0; transition:.3s;
  background:radial-gradient(ellipse at 50% 40%,rgba(0,0,0,.6),rgba(0,0,0,.88));
}
.ov.show { visibility:visible; opacity:1; }
.mc {
  background:white; padding:clamp(22px,5vw,36px) clamp(24px,6vw,44px);
  border-radius:clamp(20px,5vw,30px);
  text-align:center; display:flex; flex-direction:column; align-items:center;
  gap:.65em; box-shadow:0 20px 55px rgba(0,0,0,.45);
  max-width:clamp(260px,80vw,310px); width:88%;
}
.mc h1 { font-size:clamp(1.4rem,5.5vw,1.9rem); color:#333; line-height:1.2; }
.mc p  { color:#888; font-size:clamp(.78rem,3vw,.95rem); }
.mface {
  width:clamp(80px,22vw,115px); height:clamp(80px,22vw,115px);
  border-radius:50%; border:5px solid #FFD600; object-fit:cover;
  box-shadow:0 6px 24px rgba(0,0,0,.2); animation:mJump 1.1s ease infinite;
}
@keyframes mJump { 0%,100%{transform:translateY(0);}50%{transform:translateY(-10px);} }
.bigbtn {
  background:linear-gradient(135deg,#FF6B6B,#FF8853); color:white; border:none;
  padding:.7em 2.2em; font-size:clamp(1.1rem,4.5vw,1.5rem);
  border-radius:3em; cursor:pointer; margin-top:.5em;
  font-family:inherit; font-weight:bold;
  box-shadow:0 6px 20px rgba(255,107,107,.45); transition:transform .15s;
}
.bigbtn:active { transform:scale(.95); }

/* Mute button */
#mbtn {
  position:fixed; bottom:clamp(78px,17vh,130px); right:clamp(8px,2.5vw,14px); z-index:700;
  height:clamp(28px,6vw,36px);
  padding:0 clamp(8px,2vw,12px);
  border-radius:2em; border:2px solid white; background:rgba(255,255,255,.93);
  cursor:pointer; font-size:clamp(.6rem,2.5vw,.78rem); font-family:inherit; font-weight:bold;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 4px 12px rgba(0,0,0,.15); white-space:nowrap; color:#333;
}
</style>
</head>
<body>

<!-- BG -->
<div class="sky"></div>
<div class="sun"></div>
<div class="cloud cl1"></div>
<div class="cloud cl2"></div>
<div class="ground"></div>
<div class="sp" style="top:14%;left:6%;animation-duration:4s;animation-delay:0s"></div>
<div class="sp" style="top:21%;right:9%;animation-duration:5s;animation-delay:1.5s"></div>
<div class="sp" style="top:37%;left:4%;animation-duration:4.5s;animation-delay:.8s"></div>

<!-- Timer -->
<div class="twrap"><div class="tbar" id="tbar"></div></div>

<!-- Header -->
<div class="hdr">
  <div class="pill">Lives: <span id="livesEl">4</span></div>
  <div class="pill" id="lvlEl">Lv.1</div>
  <div class="pill">Score: <span id="scoreEl">0</span></div>
</div>

<!-- Stage -->
<div class="stage">
  <div class="gw">
    <div class="gface" id="gface">
      <img id="gimg" src="gulsabi-normal.png" alt="Gulsabi">
    </div>
    <div class="gname">Gulsabi</div>
  </div>
  <div id="tasm">
    <div class="board" id="card">
      <div class="nail tl"></div><div class="nail tr"></div>
      <div class="nail bl"></div><div class="nail br"></div>
    </div>
  </div>
</div>

<button id="mbtn" onclick="toggleMute()">Music: On</button>
<div class="deck" id="deck"></div>

<!-- START -->
<div class="ov show" id="ovStart">
  <div class="mc">
    <img class="mface" src="gulsabi-happy.png" alt="Gulsabi Happy">
    <h1>Color Cannon!</h1>
    <p>Launch the catapult that matches the color!</p>
    <button class="bigbtn" onclick="initGame()">PLAY!</button>
  </div>
</div>

<!-- GAME OVER -->
<div class="ov" id="ovEnd">
  <div class="mc">
    <img class="mface" id="endFace" src="gulsabi-sad.png" alt="Gulsabi">
    <h1 id="endTitle">Game Over</h1>
    <p>Score: <strong id="endScore">0</strong></p>
    <button class="bigbtn" onclick="initGame()">RESTART</button>

  </div>
</div>

<script>
/* ══════════════════════════════════════════
   AUDIO ENGINE
══════════════════════════════════════════ */
let AC=null, muted=false, bgOn=false, bgLoop=null, oscList=[];

function getAC(){
  if(!AC) AC=new(window.AudioContext||window.webkitAudioContext)();
  if(AC.state==='suspended') AC.resume();
  return AC;
}
let bgGain=null;
function getBG(){
  if(!bgGain){ bgGain=getAC().createGain(); bgGain.gain.value=.2; bgGain.connect(AC.destination); }
  return bgGain;
}

function nt(f,t,dur,type='triangle',vol=.1,dst){
  if(muted&&!dst) return;
  const ac=getAC(), o=ac.createOscillator(), g=ac.createGain();
  o.connect(g); g.connect(dst||ac.destination);
  o.type=type; o.frequency.setValueAtTime(f,t);
  g.gain.setValueAtTime(0,t);
  g.gain.linearRampToValueAtTime(vol,t+.012);
  g.gain.exponentialRampToValueAtTime(.0001,t+dur*.88);
  o.start(t); o.stop(t+dur);
  oscList.push(o);
}

/* ── Background music: BPM increases with game level ──
   Base BPM=148, each level adds +4 BPM, max 200           */
const BASE_BPM = 148;
const LEN = 32;
const MEL=[
  [523,0],[659,.5],[784,1],[880,1.5],[784,2],[698,2.5],[659,3],[587,3.5],
  [523,4],[659,4.5],[784,5],[1047,5.5],[880,6],[784,6.5],[698,7],[659,7.5],
  [784,8],[880,8.5],[1047,9],[880,9.5],[784,10],[659,10.5],[784,11],[698,11.5],
  [587,12],[659,12.5],[784,13],[880,13.5],[784,14],[659,14.5],[587,15],[523,15.5],
  [523,16],[784,16.5],[1047,17],[784,17.5],[659,18],[523,18.5],[659,19],[784,19.5],
  [880,20],[1047,20.5],[880,21],[784,21.5],[698,22],[659,22.5],[587,23],[523,23.5],
  [659,24],[784,24.5],[523,25],[659,25.5],[784,26],[880,26.5],[784,27],[659,27.5],
  [523,28],[659,28.5],[784,29],[659,29.5],[523,30],[587,30.5],[523,31],[523,31.5]
];
const BASS=[[131,0],[131,2],[165,4],[175,6],[196,8],[165,10],[131,12],[131,14],
            [196,16],[165,18],[131,20],[165,22],[196,24],[131,26],[165,28],[131,30]];

function getCurrentBPM(){
  const lvl = (typeof gs !== 'undefined' && gs.level) ? gs.level : 1;
  return Math.min(200, BASE_BPM + (lvl - 1) * 4);
}

function scheduleBg(t0){
  if(muted) return;
  const bpm = getCurrentBPM();
  const B   = 60 / bpm;           // seconds per beat at current level
  const g   = getBG();
  MEL.forEach( ([f,b]) => nt(f, t0+b*B, B*.75, 'triangle', .55, g));
  BASS.forEach(([f,b]) => nt(f, t0+b*B, B*2.2, 'sine',     .5,  g));
  for(let b=0;b<LEN;b++) nt(3800+(b%3)*400, t0+b*B, B*.18, 'sawtooth', b%2===0?.12:.06, g);
  [[523,659,784],[523,659,784],[523,698,880],[523,659,784]].forEach(([a,b2,c],i)=>{
    [a,b2,c].forEach(f => nt(f, t0+i*8*B, B*2.5, 'sine', .2, g));
  });
  const loopMs = LEN * B * 1000;
  bgLoop = setTimeout(()=>{ if(!muted) scheduleBg(AC.currentTime); }, loopMs - 120);
}

function startBg(){ getAC(); if(!bgOn){ bgOn=true; scheduleBg(AC.currentTime+.05); } }

/* Restart BG at new speed when level changes */
function restartBgAtNewSpeed(){
  if(muted||!bgOn) return;
  stopBg();
  bgOn=true;
  scheduleBg(AC.currentTime+.05);
}

function stopBg(){
  clearTimeout(bgLoop);
  oscList.forEach(o=>{ try{o.stop();}catch(e){} });
  oscList=[];
}

function toggleMute(){
  muted=!muted;
  document.getElementById('mbtn').textContent=muted?'Music: Off':'Music: On';
  if(muted){ stopBg(); bgOn=false; } else startBg();
}

/* ── SFX ── */
function sfxFire()  { getAC();const t=AC.currentTime;nt(900,t,.05,'square',.15);nt(500,t+.04,.07,'square',.1);nt(250,t+.08,.08,'sawtooth',.07); }
function sfxHit()   { getAC();const t=AC.currentTime;[523,659,784,1047,1319].forEach((f,i)=>nt(f,t+i*.05,.18,'sine',.2));[2093,2637].forEach((f,i)=>nt(f,t+.18+i*.06,.1,'triangle',.1)); }
function sfxMiss()  { getAC();const t=AC.currentTime;[350,262,196,147].forEach((f,i)=>nt(f,t+i*.1,.28,'sawtooth',.17));nt(98,t+.4,.35,'sine',.12); }
function sfxLvlUp() { getAC();const t=AC.currentTime;[523,659,784,1047,1319,1568,2093].forEach((f,i)=>nt(f,t+i*.065,.28,'sine',.18));setTimeout(()=>{getAC();[784,1047,1319,1568].forEach((f,i)=>nt(f,AC.currentTime+i*.07,.22,'triangle',.14));},520); }
function sfxTick()  { getAC();nt(1400,AC.currentTime,.05,'square',.13); }
function sfxCdown() { getAC();nt(660,AC.currentTime,.14,'square',.18); }
function sfxClick() { getAC();nt(1200,AC.currentTime,.04,'sine',.12); }
function sfxOver()  { getAC();const t=AC.currentTime;[392,330,262,196,147].forEach((f,i)=>nt(f,t+i*.18,.4,'sawtooth',.18)); }
function sfxWin()   { getAC();const t=AC.currentTime;[523,659,784,1047,1319,1568,2093,2637].forEach((f,i)=>nt(f,t+i*.055,.32,'sine',.2));setTimeout(()=>{getAC();[784,880,1047,1319,1568].forEach((f,i)=>nt(f,AC.currentTime+i*.07,.25,'triangle',.16));},560); }

/* ── Voice overs ──
   All loaded from audio/ folder.
   pv() plays immediately; if AudioContext is locked
   (mobile autoplay policy) we resume it first.        */
const AF='audio/';
function makeVO(file){
  const a=new Audio(AF+file);
  a.preload='auto';
  return a;
}
const VO={
  start:    makeVO('v_start.mp3'),
  timeLow:  makeVO('v_time_low.mp3'),
  gameover: makeVO('v_gameover.mp3'),
  win:      makeVO('v_win.mp3'),
  powerup:  makeVO('v_powerup.mp3'),
  oops:     makeVO('oops.mp3')        /* wrong answer / timeout */
};

function pv(v){
  if(muted) return;
  // Unlock AudioContext on mobile if needed
  if(AC && AC.state==='suspended') AC.resume();
  v.pause();
  v.currentTime=0;
  const p=v.play();
  if(p && typeof p.catch==='function') p.catch(()=>{});
}

/* ══════════════════════════
   ASSETS  (exact filenames)
══════════════════════════ */
const A='assets/';
const ALL=[
  {id:'blue',  label:'Blue',  hex:'#2196F3', dark:'#0D47A1',
   items:['blue-bird.jpg','blue-blueberry.jpg','blue-bluewhale.jpg','blue-butterfly.jpg','blue-crayon.jpg','blue-diamond.jpg','blue-fish.jpg','blue-Jeans.jpg','blue-peacock.jpg','blue-water.jpg']},
  {id:'green', label:'Green', hex:'#4CAF50', dark:'#1B5E20',
   items:['green-ball.jpg','green-brocolli.jpg','green-cactus.jpg','green-cucumber.jpg','green-diamond.jpg','green-frog.jpg','green-grasshopper.jpg','green-leaf.jpg','green-lemon.jpg','green-turtle.jpg']},
  {id:'red',   label:'Red',   hex:'#F44336', dark:'#B71C1C',
   items:['red-apple.jpg','red-baloon.jpg','red-button.jpg','red-car.jpg','red-chilli.jpg','red-crab.jpg','red-grapes.jpg','red-heart.jpg','red-rose.jpg','red-tomato.jpg']},
  {id:'yellow',label:'Yellow',hex:'#FDD835', dark:'#F57F17',
   items:['yellow-banana.jpg','yellow-bus.jpg','yellow-cap.jpg','yellow-cheese.jpg','yellow-corn.jpg','yellow-duck.jpg','yellow-lemon.jpg','yellow-sun.jpg','yellow-sunflower.jpg','yellow-taxi.jpg']},
  {id:'orange',label:'Orange',hex:'#FF6D00', dark:'#BF360C',
   items:['orange-basketball.jpg','orange-butterfly.jpg','orange-carrot.jpg','orange-cone.jpg','orange-fish.jpg','orange-flower.jpg','orange-fox.jpg','orange-orange.jpg','orange-pumpkin.jpg','orange-tiger.jpg']},
  {id:'pink',  label:'Pink',  hex:'#E91E8C', dark:'#880E4F',
   items:['pink-brain.jpg','pink-cottoncand.jpg','pink-doughnut.jpg','pink-eraser.jpg','pink-flamingo.jpg','pink-lotus.jpg','pink-peach.jpg','pink-pig.jpg','pink-ribbon.jpg','pink-shoe.jpg']},
  {id:'purple',label:'Purple',hex:'#9C27B0', dark:'#4A148C',
   items:['purple-beetroot.jpg','purple-brinjal.jpg','purple-crayon.jpg','purple-crystal.jpg','purple-fig.jpg','purple-flower.jpg','purple-grapes.jpg','purple-octopus.jpg','purple-plant.jpg','purple-plum.jpg']},
  {id:'brown', label:'Brown', hex:'#8D6E63', dark:'#3E2723',
   items:['brown-baseball.jpg','brown-biscut.jpg','brown-box.jpg','brown-bread.jpg','brown-chocolate.jpg','brown-coconut.jpg','brown-monkey.jpg','brown-potato.jpg','brown-teddy.jpg','brown-woodlog.jpg']}
];

/* ══════════════════════════
   GAME STATE
══════════════════════════ */
let active=[], gs={}, gi=null, warnT=false, rxH=null;

function setG(mood,anim,rev){
  const f=document.getElementById('gface'), im=document.getElementById('gimg');
  const M={normal:'gulsabi-normal.png',happy:'gulsabi-happy.png',sad:'gulsabi-sad.png',thinking:'gulsabi-thinking.png'};
  im.src=M[mood]||M.normal;
  f.className='gface '+mood; void f.offsetWidth;
  if(anim) f.classList.add(anim);
  if(rev){ clearTimeout(rxH); rxH=setTimeout(()=>setG('normal',null,null),rev); }
}

function initGame(){
  document.querySelectorAll('.ov').forEach(e=>e.classList.remove('show'));
  gs={score:0,lives:4,level:1,maxLvl:8,timer:12,tmax:12,card:null,busy:false};
  active=[...ALL].sort(()=>Math.random()-.5).slice(0,4);
  setG('normal',null,null);
  startBg(); pv(VO.start);
  renderCannons(); dealCard(); updateUI();
  if(gi) clearInterval(gi);
  gi=setInterval(tick,100);
}

function tick(){
  if(!gs.card||gs.busy) return;
  gs.timer-=.1;
  const pct=(gs.timer/gs.tmax)*100;
  const bar=document.getElementById('tbar');
  bar.style.width=pct+'%';
  bar.style.background=pct>55?'#69F0AE':pct>28?'#FFAB00':'#FF1744';
  if(pct<28&&!warnT){ warnT=true; sfxCdown(); pv(VO.timeLow); setG('thinking','awiggle',null); }
  if(gs.timer<3&&gs.timer>0&&Math.abs(gs.timer%1)<.15) sfxTick();
  if(gs.timer<=0) handleMiss();
}

function dealCard(){
  warnT=false; gs.timer=gs.tmax; gs.busy=false;
  document.getElementById('tbar').style.background='#69F0AE';
  const col=active[Math.floor(Math.random()*active.length)];
  const file=col.items[Math.floor(Math.random()*col.items.length)];
  gs.card={cid:col.id,file,label:col.label,hex:col.hex};
  setG('normal',null,null);
  const asm=document.getElementById('tasm');
  asm.classList.remove('adrop'); void asm.offsetWidth; asm.classList.add('adrop');
  document.getElementById('card').innerHTML=`
    <div class="nail tl"></div><div class="nail tr"></div>
    <div class="nail bl"></div><div class="nail br"></div>
    <div class="iframe">
      <img src="${A}${gs.card.file}" alt="${col.label}"
        onerror="this.parentElement.innerHTML='<div style=color:${col.hex};font-size:3rem;font-weight:900>${col.label[0]}</div>'">
    </div>`;
}

function fire(cid,el){
  if(gs.busy) return;
  gs.busy=true; sfxFire();
  el.classList.add('cfire'); setTimeout(()=>el.classList.remove('cfire'),220);
  const r=el.getBoundingClientRect();
  const hx=active.find(c=>c.id===cid)?.hex||'#999';
  // projectile
  const p=document.createElement('div'); p.className='proj';
  p.style.cssText=`width:16px;height:16px;left:${r.left+r.width/2-8}px;top:${r.top}px;background:${hx};box-shadow:0 0 10px ${hx};`;
  document.body.appendChild(p); setTimeout(()=>p.remove(),420);
  // flash
  const fl=document.createElement('div'); fl.className='sflash';
  document.body.appendChild(fl);
  const ok=cid===gs.card.cid;
  fl.classList.add(ok?'fhit':'fmiss'); setTimeout(()=>fl.remove(),440);

  if(ok){
    const pts=100+gs.level*15; gs.score+=pts;
    sfxHit(); setG('happy','abounce',1100);
    const sp=document.createElement('div'); sp.className='spop';
    sp.textContent='+'+pts;
    sp.style.cssText=`left:${r.left+5}px;top:${r.top-15}px;`;
    document.body.appendChild(sp); setTimeout(()=>sp.remove(),1100);
    spawnConfetti(r.left+r.width/2,r.top);
    if(gs.score>=gs.level*1400){
      if(gs.level>=gs.maxLvl){endGame(true);return;}
      gs.level++; gs.tmax=Math.max(6.5,12-gs.level*.55);
      sfxLvlUp(); pv(VO.powerup);
      restartBgAtNewSpeed();   /* music speeds up at new level */
      setG('happy','abounce',null); updateUI();
      active=[...ALL].sort(()=>Math.random()-.5).slice(0,4);
      renderCannons(); setTimeout(dealCard,500);
    } else { setTimeout(dealCard,450); }
  } else { handleMiss(); }
}

function handleMiss(){
  gs.lives--;
  sfxMiss();
  pv(VO.oops);   /* plays on wrong answer AND on timeout */
  setG('sad','ashake',1200); updateUI();
  if(gs.lives<=0) endGame(false);
  else setTimeout(dealCard,900);
}

const CC=['#FF5252','#FF6D00','#FFD600','#69F0AE','#40C4FF','#E040FB','#FF4081','#00E5FF'];
function spawnConfetti(cx,cy){
  for(let i=0;i<22;i++){
    const c=document.createElement('div'); c.className='conf';
    const ang=Math.random()*Math.PI*2, r=50+Math.random()*85, dur=.65+Math.random()*.7;
    c.style.cssText=`left:${cx+Math.cos(ang)*r-4}px;top:${cy}px;background:${CC[i%CC.length]};border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${dur}s;`;
    document.body.appendChild(c); setTimeout(()=>c.remove(),dur*1000+80);
  }
}

/* ══════════════════════════════════════════
   CATAPULT — vivid solid-color design
   Every part is painted in the catapult's
   own color family so it's instantly obvious
══════════════════════════════════════════ */
function renderCannons(){
  const deck=document.getElementById('deck'); deck.innerHTML='';
  active.forEach(col=>{
    const btn=document.createElement('div'); btn.className='cw';

    const V  = col.hex;          // vivid main color
    const D  = col.dark;         // dark shade for outlines / accents
    // compute a light tint by blending toward white
    function tint(h,t){
      const r=parseInt(h.slice(1,3),16), g=parseInt(h.slice(3,5),16), b=parseInt(h.slice(5,7),16);
      const nr=Math.round(r+(255-r)*t), ng=Math.round(g+(255-g)*t), nb=Math.round(b+(255-b)*t);
      return '#'+[nr,ng,nb].map(v=>v.toString(16).padStart(2,'0')).join('');
    }
    const LIGHT = tint(V, 0.55);   // pastel tint for highlights
    const PALE  = tint(V, 0.82);   // very pale for label bg
    const MID   = tint(V, 0.25);   // slightly lighter than vivid

    btn.innerHTML=`
    <svg viewBox="0 0 72 86" xmlns="http://www.w3.org/2000/svg" overflow="visible">
      <defs>
        <!-- Ball gradient: white core → vivid → dark -->
        <radialGradient id="bg${col.id}" cx="35%" cy="30%" r="65%">
          <stop offset="0%"   stop-color="white"/>
          <stop offset="40%"  stop-color="${LIGHT}"/>
          <stop offset="100%" stop-color="${V}"/>
        </radialGradient>
        <!-- Outer glow disc -->
        <radialGradient id="gg${col.id}" cx="50%" cy="50%" r="50%">
          <stop offset="0%"   stop-color="${V}"     stop-opacity=".55"/>
          <stop offset="100%" stop-color="${V}"     stop-opacity="0"/>
        </radialGradient>
      </defs>

      <!-- ── GLOW DISC behind ball ── -->
      <circle cx="36" cy="11" r="18" fill="url(#gg${col.id})"/>

      <!-- ════ BASE PLATFORM ════ -->
      <!-- main slab — vivid color, thick white outline -->
      <rect x="2" y="63" width="68" height="15" rx="7"
            fill="${V}" stroke="white" stroke-width="2.5"/>
      <!-- dark inset line for wood grain feel -->
      <rect x="4" y="68" width="64" height="2" rx="1" fill="${D}" opacity=".25"/>
      <!-- plank dividers -->
      <line x1="18" y1="64" x2="18" y2="77" stroke="white" stroke-width="1.2" opacity=".4"/>
      <line x1="36" y1="64" x2="36" y2="77" stroke="white" stroke-width="1.2" opacity=".4"/>
      <line x1="54" y1="64" x2="54" y2="77" stroke="white" stroke-width="1.2" opacity=".4"/>
      <!-- top highlight strip -->
      <rect x="4" y="64" width="64" height="3.5" rx="2" fill="white" opacity=".28"/>

      <!-- WHEELS — dark hub, vivid rim -->
      <circle cx="12" cy="71.5" r="6"   fill="${D}"   stroke="white" stroke-width="2"/>
      <circle cx="12" cy="71.5" r="3"   fill="${V}"   stroke="white" stroke-width="1"/>
      <circle cx="60" cy="71.5" r="6"   fill="${D}"   stroke="white" stroke-width="2"/>
      <circle cx="60" cy="71.5" r="3"   fill="${V}"   stroke="white" stroke-width="1"/>

      <!-- ════ LEFT POST ════ -->
      <rect x="14" y="33" width="13" height="32" rx="6.5"
            fill="${V}" stroke="white" stroke-width="2.2"/>
      <rect x="16.5" y="35" width="5" height="26" rx="2.5"
            fill="white" opacity=".22"/>

      <!-- ════ RIGHT POST ════ -->
      <rect x="45" y="33" width="13" height="32" rx="6.5"
            fill="${V}" stroke="white" stroke-width="2.2"/>
      <rect x="47.5" y="35" width="5" height="26" rx="2.5"
            fill="white" opacity=".22"/>

      <!-- ════ AXLE BAR ════ -->
      <rect x="19" y="48" width="34" height="9" rx="4.5"
            fill="${D}" stroke="white" stroke-width="1.8"/>
      <!-- pivot bolt -->
      <circle cx="36" cy="52.5" r="5.5" fill="${V}"   stroke="white" stroke-width="2"/>
      <circle cx="36" cy="52.5" r="2.5" fill="white"  opacity=".8"/>

      <!-- ════ SWING ARM ════ -->
      <rect x="31.5" y="13" width="9" height="42" rx="4.5"
            fill="${MID}" stroke="white" stroke-width="2"/>
      <rect x="33.5" y="15" width="4" height="36" rx="2"
            fill="white" opacity=".25"/>

      <!-- ════ SLING BANDS ════ -->
      <!-- outer band (white) for visibility -->
      <line x1="18" y1="37" x2="36" y2="12" stroke="white"  stroke-width="4.5" stroke-linecap="round"/>
      <line x1="54" y1="37" x2="36" y2="12" stroke="white"  stroke-width="4.5" stroke-linecap="round"/>
      <!-- inner band (vivid color) -->
      <line x1="18" y1="37" x2="36" y2="12" stroke="${V}"   stroke-width="2.8" stroke-linecap="round"/>
      <line x1="54" y1="37" x2="36" y2="12" stroke="${V}"   stroke-width="2.8" stroke-linecap="round"/>

      <!-- ════ BOWL / CRADLE ════ -->
      <path d="M23,14 Q36,2 49,14 L46,23 Q36,17 26,23 Z"
            fill="${V}" stroke="white" stroke-width="2.2"/>
      <!-- bowl shine arc -->
      <path d="M27,13 Q36,4 45,13"
            fill="none" stroke="white" stroke-width="2.5"
            stroke-linecap="round" opacity=".5"/>

      <!-- ════ BALL — large, vivid, unmissable ════ -->
      <circle cx="36" cy="10" r="12"
              fill="url(#bg${col.id})" stroke="white" stroke-width="2.5"/>
      <!-- main shine -->
      <circle cx="31" cy="5"  r="4.5" fill="white" opacity=".55"/>
      <circle cx="30" cy="4"  r="2.2" fill="white" opacity=".85"/>
      <!-- color label on ball — small colored circle for extra hint -->
      <circle cx="41" cy="14" r="4"   fill="${D}"  stroke="white" stroke-width="1.2"/>
      <circle cx="41" cy="14" r="2"   fill="${V}"/>
    </svg>
    <!-- Label chip in the catapult's own color -->
    <div class="clabel" style="background:${V};color:white;border-color:${D};">
      ${col.label}
    </div>`;

    btn.onclick=()=>{ sfxClick(); fire(col.id,btn); };
    deck.appendChild(btn);
  });
}

function endGame(win){
  clearInterval(gi); stopBg(); bgOn=false;
  document.getElementById('endScore').textContent=gs.score;
  document.getElementById('endTitle').textContent=win?'You\'re Amazing!':'Game Over';
  document.getElementById('endFace').src=win?'gulsabi-happy.png':'gulsabi-sad.png';
  setG(win?'happy':'sad',win?'abounce':'ashake',null);
  if(win){sfxWin();pv(VO.win);spawnConfetti(window.innerWidth/2,window.innerHeight/3);}
  else   {sfxOver();pv(VO.gameover);}
  document.getElementById('ovEnd').classList.add('show');
}

function updateUI(){
  document.getElementById('scoreEl').textContent=gs.score;
  document.getElementById('livesEl').textContent=gs.lives;
  document.getElementById('lvlEl').textContent='Lv.'+gs.level;
}
</script>
</body>
</html>