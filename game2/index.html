<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gulsabi's Color Basket</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-hue: 200;
            --header-bg: rgba(255, 255, 255, 0.95);
            --primary-color: #4ECDC4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Fredoka One', cursive, sans-serif;
            background: linear-gradient(180deg, hsl(var(--bg-hue), 80%, 85%) 0%, hsl(var(--bg-hue), 60%, 95%) 100%);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            transition: background 1s ease;
        }

        /* --- Main Game Container --- */
        .app-container {
            width: 100%;
            max-width: 1000px;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 50px rgba(0,0,0,0.1);
        }

        /* --- Header --- */
        .header {
            padding: 10px 20px;
            background: var(--header-bg);
            border-bottom: 4px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .left-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* --- AVATAR & ANIMATION --- */
        .avatar-wrapper {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            border: 4px solid #FF9F43;
            background: #FFF8DC;
            box-shadow: 0 4px 0 #E58E26;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .avatar-pop {
            animation: popAvatar 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popAvatar {
            0% { transform: scale(1); }
            50% { transform: scale(1.25); box-shadow: 0 0 20px #FF9F43; }
            100% { transform: scale(1); }
        }

        .avatar-img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: none; 
            position: relative; 
            z-index: 2; 
            background: #FFF8DC; 
        }
        
        .avatar-emoji { 
            font-size: 3.5rem;
            line-height: 1; 
            position: absolute; 
            animation: bounce 2s infinite; 
            z-index: 1; 
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .game-title {
            color: #FF6B6B;
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 0px white;
            display: block;
        }

        .stat-group { display: flex; flex-direction: column; justify-content: center; }
        .stat-pill { font-size: 1rem; color: #444; display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        .hearts { font-size: 1.1rem; margin-top: 2px; }

        .header-controls { display: flex; gap: 10px; align-items: center; }
        
        .icon-btn {
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s, filter 0.2s;
        }
        
        .icon-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .icon-btn:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-music { background: #FF6B6B; }
        .btn-screen { background: #4ECDC4; }
        .btn-help { background: #FF9F43; }
        .btn-reset { background: #546E7A; }

        /* --- Game Area --- */
        .game-area {
            flex: 1;
            position: relative;
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-content: center;
            gap: 20px;
            overflow-y: auto;
        }

        .item {
            font-size: 4rem;
            cursor: pointer;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
            animation: float 3s ease-in-out infinite;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 90px;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid white;
        }

        .item:hover { transform: scale(1.1); }
        .item:nth-child(odd) { animation-delay: 0.5s; }
        
        .item.selected {
            transform: scale(1.3) rotate(10deg);
            background: #fff;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.9);
            z-index: 100;
            border-color: #333;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* --- Baskets --- */
        .baskets-container {
            min-height: 180px; /* Increased height for new design */
            background: rgba(255, 255, 255, 0.6);
            border-top: 4px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding: 0 20px 20px 20px;
            gap: 15px;
            z-index: 20;
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
        }

        /* NEW BASKET DESIGN */
        .basket {
            flex: 1;
            max-width: 110px;
            height: 150px;
            background: transparent;
            /* Deep curve at bottom, straight top */
            border-radius: 0 0 40px 40px; 
            border: 4px solid white;
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Clips children to rounded corners */
            cursor: pointer;
            transition: transform 0.2s;
        }

        .basket:hover { transform: translateY(-5px); }
        .basket:active { transform: scale(0.95) translateY(0); }

        .basket-top {
            height: 35%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            padding-top: 5px;
        }

        .basket-bottom {
            height: 65%;
            width: 100%;
            /* Color is set dynamically via JS */
        }

        /* --- Overlays --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px);
            border-radius: inherit;
        }

        .overlay.visible { visibility: visible; opacity: 1; }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 30px;
            text-align: center;
            border: 6px solid var(--primary-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            margin-top: 40px;
        }

        .modal-photo-wrapper {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 6px solid #FFE66D;
            margin: -90px auto 20px auto;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .modal-emoji { font-size: 5rem; position: absolute; z-index: 1; }
        .modal-photo-wrapper .avatar-img { z-index: 2; }

        @keyframes popIn {
            from { transform: scale(0.5); }
            to { transform: scale(1); }
        }

        .btn {
            background: linear-gradient(to bottom, #4ECDC4, #26A69A);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.4rem;
            border-radius: 50px;
            font-family: inherit;
            cursor: pointer;
            box-shadow: 0 6px 0 #16a085;
            transition: transform 0.1s;
            width: 100%;
            margin-top: 15px;
        }

        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-secondary { background: linear-gradient(to bottom, #FF9F43, #E58E26); box-shadow: 0 6px 0 #D35400; }
        .btn-danger { background: linear-gradient(to bottom, #FF6B6B, #D32F2F); box-shadow: 0 6px 0 #B71C1C; }

        /* --- Effects --- */
        .feedback-emoji {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 8rem;
            z-index: 3000;
            pointer-events: none;
        }
        .feedback-emoji.animate { animation: emojiPop 0.8s ease-out forwards; }

        @keyframes emojiPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-45deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }

        .float-text {
            position: absolute;
            color: #FF6B6B;
            font-size: 2.5rem;
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 1s forwards;
            z-index: 500;
            text-shadow: 3px 3px 0px white;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-60px) scale(1.5); opacity: 0; }
        }

        .combo-text {
            position: absolute;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            color: #FF9F43;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 0px white;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 50;
        }
        
        .confetti {
            position: fixed;
            width: 12px; height: 12px;
            background: #f00;
            animation: confettiFall 3s linear forwards;
            z-index: 1500;
        }
        @keyframes confettiFall {
            0% { transform: translateY(-10vh) rotate(0deg); }
            100% { transform: translateY(110vh) rotate(720deg); }
        }

        /* --- MOBILE RESPONSIVENESS (<600px) --- */
        @media (max-width: 600px) {
            .app-container { max-width: 100%; box-shadow: none; background: transparent; }
            .header { padding: 5px 10px; }
            .game-title { display: none; }
            .item { font-size: 2.8rem; width: 65px; height: 65px; border-width: 2px; }
            
            /* Adjust Basket size for mobile */
            .basket { max-width: 75px; height: 110px; border-radius: 0 0 25px 25px; border-width: 3px; }
            .basket-top { font-size: 0.8rem; height: 35%; }
            .baskets-container { gap: 8px; padding: 0 5px 10px 5px; min-height: 130px; }
            
            .avatar-wrapper { width: 60px; height: 60px; }
            .avatar-emoji { font-size: 2.8rem; }
            .icon-btn { width: 36px; height: 36px; font-size: 1.1rem; }
            .btn { padding: 12px 20px; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="header">
            <div class="left-section">
                <div class="avatar-wrapper" id="headerAvatarWrapper">
                    <div class="avatar-emoji" id="navEmoji">üêµ</div>
                    <img src="" class="avatar-img" id="navImg" alt="Avatar" onerror="handleImageError(this)">
                </div>
                <div class="stat-group">
                    <div class="stat-pill">‚≠ê <span id="score">0</span></div>
                    <div class="stat-pill hearts" id="livesDisplay">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                </div>
            </div>
            
            <h1 class="game-title">Gulsabi's Color Basket</h1>
            
            <div class="header-controls">
                <button onclick="showInstructions()" class="icon-btn btn-help" title="Help">‚ùì</button>
                <button onclick="requestRestart()" class="icon-btn btn-reset" title="Restart">üîÑ</button>
                <button onclick="toggleMusic()" class="icon-btn btn-music" id="musicBtn" title="Sound">üéµ</button>
                <button onclick="toggleFullscreen()" class="icon-btn btn-screen" title="Full Screen">‚õ∂</button>
            </div>
        </div>

        <div class="combo-text" id="comboDisplay">üî• Combo x2!</div>
        <div class="game-area" id="gameArea"></div>
        <div class="baskets-container" id="basketArea"></div>

        <div class="overlay visible" id="startOverlay">
            <div class="modal">
                <div class="modal-photo-wrapper">
                    <div class="modal-emoji" id="startEmoji">üêµ</div>
                    <img src="" class="avatar-img" id="startImg" alt="Avatar" onerror="handleImageError(this)">
                </div>
                <h2>Gulsabi's<br>Color Basket</h2>
                <p style="color:#666; font-size: 1.1rem; margin: 15px 0;">
                    1. Tap a floating item.<br>
                    2. Drop it in the matching basket.<br>
                    3. Be quick for time bonus! ‚è±Ô∏è
                </p>
                <button class="btn" onclick="startGame()" id="playBtn">Play Now</button>
                <button class="btn btn-secondary" onclick="closeOverlay('startOverlay')" id="resumeBtn" style="display:none">Resume</button>
            </div>
        </div>

        <div class="overlay" id="restartOverlay">
            <div class="modal" style="border-color: #546E7A;">
                <h2 style="color:#546E7A; margin-top:10px;">Restart Game?</h2>
                <p style="color:#666;">Your score will reset to 0.</p>
                <button class="btn btn-danger" onclick="confirmRestart()">Yes, Restart</button>
                <button class="btn btn-secondary" onclick="closeOverlay('restartOverlay')">Cancel</button>
            </div>
        </div>

        <div class="overlay" id="gameOverOverlay">
            <div class="modal" style="border-color: #FF6B6B;">
                <div class="modal-photo-wrapper" style="border-color:#FF6B6B;">
                    <div class="modal-emoji" id="overEmoji">üôà</div>
                    <img src="" class="avatar-img" id="overImg" alt="Avatar" onerror="handleImageError(this)">
                </div>
                <h2 style="color:#FF6B6B">Game Over!</h2>
                <p style="font-size: 1.4rem;">Final Score: <span id="finalScore" style="font-weight:bold;">0</span></p>
                <button class="btn" onclick="startGame()">Try Again</button>
            </div>
        </div>

        <div class="overlay" id="levelOverlay">
            <div class="modal">
                <div class="modal-photo-wrapper">
                    <div class="modal-emoji" id="winEmoji">üêµ</div>
                    <img src="" class="avatar-img" id="winImg" alt="Avatar" onerror="handleImageError(this)">
                </div>
                <h2 style="color:#4ECDC4">Level Up!</h2>
                <p>Time Taken: <span id="timeTakenDisplay" style="font-weight:bold">0s</span></p>
                <p style="color:#FF9F43; font-weight:bold; font-size:1.2rem;">+<span id="timeBonusDisplay">0</span> Time Bonus!</p>
                <button class="btn" onclick="nextLevel()">Next Level</button>
            </div>
        </div>
    </div>

    <div class="feedback-emoji" id="feedbackEmoji">üåü</div>

    <script>
        // ================= ERROR HANDLING =================
        function handleImageError(imgElement) {
            imgElement.style.display = 'none'; // Hide broken image
        }

        // ================= CONFIG =================
        const photos = {
            normal: "images/gulsabi-normal.png",
            thinking: "images/gulsabi-thinking.png",
            happy: "images/gulsabi-happy.png",
            sad: "images/gulsabi-sad.png"
        };
        const emojis = { normal: "üêµ", thinking: "üôâ", happy: "üêµ", sad: "üôà" };
        
        // Items kept for falling logic, but icons removed from basket display
        const masterData = [
            { name: 'Red', hex: '#FF5252', items: ['üëø', 'üçé','üíñ','üçí','üçì','üöó','üéà','ü•ä','‚òéÔ∏è','üåπ'] },
            { name: 'Blue', hex: '#2979FF', items: ['üëñ','üß¢','üê≥','üíé','üßä','üåÄ','üêü'] },
            { name: 'Green', hex: '#00C853', items: ['üöô','ü•¶','üê¢','üêä','üåµ','üçè','ü•ù','üå≤'] },
            { name: 'Yellow', hex: '#FFD600', items: ['üçå','üçã','üßÄ','üêù','üëë','üöï','üåª','üç™'] },
            { name: 'Orange', hex: '#FF9100', items: ['üçä','üèÄ','ü•ï','ü¶ä','üéÉ','üìô','üêÖ','ü¶∫','üêú'] },
            { name: 'Purple', hex: '#AA00FF', items: ['üçá','üçÜ','üëæ','‚òÇÔ∏è','üîÆ'] },
            { name: 'Pink', hex: '#FF4081', items: ['üéÄ','üê∑','üçß','üß†','ü©∞','üëõ'] },
            { name: 'Brown', hex: '#795548', items: ['üêª','ü•î','üö™','üíº','üëû','üéª','ü¶ñ'] },
            { name: 'Black', hex: '#37474F', items: ['üêº','üé±','üé©','üí£','üï∑Ô∏è','üêß','üé¨'] }
        ];

        // ================= GAME LOGIC =================
        let state = {
            score: 0, level: 1, lives: 4, combo: 0,
            selectedItem: null, activeItems: [], currentColors: [],
            musicPlaying: false, audioCtx: null, nextNoteTime: 0, noteIndex: 0,
            gameActive: false, bgHue: 200,
            levelStartTime: 0
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Audio System
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'pop') {
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'success') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(523 + (state.combo * 50), now); 
                osc.frequency.setValueAtTime(659 + (state.combo * 50), now + 0.1); 
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'gameover') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(50, now + 1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 1);
                osc.start(now);
                osc.stop(now + 1);
            } else if (type === 'levelup') {
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.type = i===3 ? 'sine' : 'triangle';
                    o.frequency.value = freq;
                    const startT = now + (i * 0.1);
                    const dur = i===3 ? 0.6 : 0.1;
                    g.gain.setValueAtTime(0.2, startT);
                    g.gain.exponentialRampToValueAtTime(0.001, startT + dur);
                    o.start(startT);
                    o.stop(startT + dur);
                });
            }
        }

        const melody = [
            {f: 392, d: 0.2}, {f: 523, d: 0.2}, {f: 659, d: 0.2}, {f: 523, d: 0.2}, 
            {f: 392, d: 0.2}, {f: 392, d: 0.2}, {f: 523, d: 0.4},
            {f: 587, d: 0.2}, {f: 659, d: 0.2}, {f: 587, d: 0.2}, {f: 523, d: 0.2}, 
            {f: 493, d: 0.4}, {f: 0, d: 0.2}
        ];

        function scheduler() {
            if (!state.musicPlaying) return;
            while (state.nextNoteTime < audioCtx.currentTime + 0.1) {
                scheduleNote(state.nextNoteTime);
                advanceNote();
            }
            requestAnimationFrame(scheduler);
        }

        function scheduleNote(time) {
            const note = melody[state.noteIndex];
            if (note.f > 0) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sine';
                osc.frequency.value = note.f;
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                gain.gain.setValueAtTime(0.05, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + note.d - 0.05);
                osc.start(time);
                osc.stop(time + note.d);
            }
        }

        function advanceNote() {
            state.nextNoteTime += melody[state.noteIndex].d * 0.6;
            state.noteIndex = (state.noteIndex + 1) % melody.length;
        }

        function toggleMusic() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            state.musicPlaying = !state.musicPlaying;
            document.getElementById('musicBtn').textContent = state.musicPlaying ? 'üéµ' : 'üîá';
            if (state.musicPlaying) {
                state.nextNoteTime = audioCtx.currentTime;
                scheduler();
            }
        }

        // --- Core ---
        window.onload = function() { 
            updateAvatar('normal'); 
        };

        function updateAvatar(mood) {
            // 1. Update Images and Text
            const ids = [['navImg','navEmoji'], ['startImg','startEmoji'], ['winImg','winEmoji'], ['overImg', 'overEmoji']];
            ids.forEach(pair => {
                const imgEl = document.getElementById(pair[0]);
                const emoEl = document.getElementById(pair[1]);
                emoEl.textContent = emojis[mood];
                
                if (photos[mood]) { 
                    imgEl.src = photos[mood]; 
                    imgEl.style.display = 'block'; 
                } else { 
                    imgEl.style.display = 'none'; 
                }
            });

            // 2. Trigger Pop Animation on Header Avatar
            const animWrapper = document.getElementById('headerAvatarWrapper');
            if(animWrapper) {
                animWrapper.classList.remove('avatar-pop');
                void animWrapper.offsetWidth; // Trigger reflow
                animWrapper.classList.add('avatar-pop');
            }
        }

        function showInstructions() {
            document.getElementById('startOverlay').classList.add('visible');
            if (state.gameActive) {
                document.getElementById('playBtn').style.display = 'none';
                document.getElementById('resumeBtn').style.display = 'inline-block';
            } else {
                document.getElementById('playBtn').style.display = 'inline-block';
                document.getElementById('resumeBtn').style.display = 'none';
            }
        }

        function closeOverlay(id) { document.getElementById(id).classList.remove('visible'); }
        function requestRestart() { document.getElementById('restartOverlay').classList.add('visible'); }
        function confirmRestart() { state.musicPlaying = false; toggleMusic(); startGame(); }

        function startGame() {
            state.score = 0; state.level = 1; state.lives = 4; state.combo = 0; state.bgHue = 200;
            document.documentElement.style.setProperty('--bg-hue', state.bgHue);
            document.getElementById('score').textContent = '0';
            updateLivesUI();
            document.querySelectorAll('.overlay').forEach(el => el.classList.remove('visible'));
            state.gameActive = true;
            if(!state.musicPlaying) toggleMusic();
            startLevel();
        }

        function updateLivesUI() {
            let hearts = "";
            for(let i=0; i<state.lives; i++) hearts += "‚ù§Ô∏è";
            for(let i=state.lives; i<4; i++) hearts += "üñ§"; 
            document.getElementById('livesDisplay').textContent = hearts;
        }

        function showGameOver() {
            state.gameActive = false;
            playSound('gameover');
            updateAvatar('sad');
            document.getElementById('finalScore').textContent = state.score;
            document.getElementById('gameOverOverlay').classList.add('visible');
        }

        function startLevel() {
            updateAvatar('normal');
            state.activeItems = [];
            state.selectedItem = null;
            state.bgHue = (state.bgHue + 40) % 360;
            document.documentElement.style.setProperty('--bg-hue', state.bgHue);
            
            state.levelStartTime = Date.now();

            const numBaskets = state.level === 1 ? 4 : 4 + Math.min(Math.floor((state.level-1)/2), 2);
            
            const shuffledColors = [...masterData].sort(() => 0.5 - Math.random());
            state.currentColors = shuffledColors.slice(0, numBaskets);

            renderBaskets();
            renderItems();
        }

        // UPDATED BASKET RENDERING LOGIC
        function renderBaskets() {
            const container = document.getElementById('basketArea');
            container.innerHTML = '';
            state.currentColors.forEach(c => {
                const b = document.createElement('div');
                b.className = 'basket';
                b.dataset.colorName = c.name;
                // Add the two-part visual structure
                b.innerHTML = `
                    <div class="basket-top" style="color:${c.hex}">${c.name}</div>
                    <div class="basket-bottom" style="background-color:${c.hex}"></div>
                `;
                b.onclick = () => handleBasketClick(c.name);
                container.appendChild(b);
            });
        }

        function renderItems() {
            const area = document.getElementById('gameArea');
            area.innerHTML = '';
            let levelItems = [];
            state.currentColors.forEach(c => {
                const shuffledItems = c.items.sort(() => 0.5 - Math.random());
                const picks = shuffledItems.slice(0, 3);
                picks.forEach(emoji => levelItems.push({ emoji: emoji, colorName: c.name }));
            });
            levelItems.sort(() => 0.5 - Math.random());
            levelItems.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = 'item';
                el.textContent = item.emoji;
                el.dataset.colorName = item.colorName;
                el.dataset.id = index;
                el.onclick = (e) => { e.stopPropagation(); selectItem(el); };
                area.appendChild(el);
                state.activeItems.push(el);
            });
        }

        function selectItem(el) {
            if (state.selectedItem) state.selectedItem.classList.remove('selected');
            if (state.selectedItem === el) {
                state.selectedItem = null; playSound('pop'); updateAvatar('normal'); return;
            }
            state.selectedItem = el; el.classList.add('selected'); playSound('pop'); updateAvatar('thinking');
        }

        function handleBasketClick(basketColorName) {
            if (!state.selectedItem || !state.gameActive) return;
            const itemColorName = state.selectedItem.dataset.colorName;
            if (basketColorName === itemColorName) handleSuccess();
            else handleError();
        }

        function handleSuccess() {
            state.combo++;
            let points = 10 + (state.combo * 2);
            playSound('success');
            updateAvatar('happy');
            showFloatText(state.selectedItem, `+${points}`);
            
            if(state.combo > 1) {
                const comboDiv = document.getElementById('comboDisplay');
                comboDiv.textContent = `üî• Combo x${state.combo}!`;
                comboDiv.style.opacity = '1';
                setTimeout(() => comboDiv.style.opacity = '0', 1000);
            }

            state.selectedItem.style.transform = 'scale(0) translateY(50px)';
            state.selectedItem.style.opacity = '0';
            const id = state.selectedItem.dataset.id;
            state.activeItems = state.activeItems.filter(f => f.dataset.id !== id);
            let elToRemove = state.selectedItem;
            setTimeout(() => elToRemove.remove(), 300);

            state.selectedItem = null;
            state.score += points;
            document.getElementById('score').textContent = state.score;

            if (state.activeItems.length === 0) setTimeout(showLevelComplete, 1000);
            else setTimeout(() => { if(!state.selectedItem) updateAvatar('normal'); }, 1500);
        }

        function handleError() {
            state.lives--; state.combo = 0; updateLivesUI();
            if(state.lives <= 0) { showGameOver(); return; }
            
            playSound('error'); updateAvatar('sad'); showFloatText(state.selectedItem, "‚ùå");
            state.selectedItem.style.transform = 'translateX(10px)';
            setTimeout(() => {
                state.selectedItem.style.transform = 'translateX(-10px)';
                setTimeout(() => {
                    if (state.selectedItem) { state.selectedItem.classList.remove('selected'); state.selectedItem = null; }
                    setTimeout(() => { if(state.lives > 0) updateAvatar('normal'); }, 1000);
                }, 100);
            }, 100);
            showFloatingFeedback('‚ùå');
        }

        function showFloatText(element, text) {
            const rect = element.getBoundingClientRect();
            const floatEl = document.createElement('div');
            floatEl.className = 'float-text';
            floatEl.textContent = text;
            floatEl.style.left = rect.left + 'px';
            floatEl.style.top = rect.top + 'px';
            document.body.appendChild(floatEl);
            setTimeout(() => floatEl.remove(), 1000);
        }

        function showFloatingFeedback(emoji) {
            const el = document.getElementById('feedbackEmoji');
            el.textContent = emoji;
            el.classList.remove('animate');
            void el.offsetWidth;
            el.classList.add('animate');
        }

        function showLevelComplete() {
            const timeTaken = Math.floor((Date.now() - state.levelStartTime) / 1000);
            let bonus = 0;
            
            if(timeTaken < 15) bonus = 100;
            else if(timeTaken < 25) bonus = 50;
            else if(timeTaken < 35) bonus = 20;

            state.score += bonus;
            document.getElementById('score').textContent = state.score;

            document.getElementById('timeTakenDisplay').textContent = `${timeTaken}s`;
            document.getElementById('timeBonusDisplay').textContent = bonus;

            playSound('levelup');
            document.getElementById('levelOverlay').classList.add('visible');
            updateAvatar('happy');
            fireConfetti();
        }

        function fireConfetti() {
            for(let i=0; i<30; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.background = `hsl(${Math.random()*360}, 100%, 50%)`;
                conf.style.animationDuration = (Math.random() * 2 + 1) + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 3000);
            }
        }

        function nextLevel() {
            state.level++;
            document.getElementById('levelOverlay').classList.remove('visible');
            startLevel();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => console.log(e)); }
            else { if (document.exitFullscreen) document.exitFullscreen(); }
        }
    </script>
</body>
</html>